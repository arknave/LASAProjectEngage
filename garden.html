<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Project Engage Programming</title>
	
	<link type="text/css" href="stylesheets/custom-theme/jquery-ui-1.8.21.custom.css" rel="stylesheet" />
	<link href="stylesheets/blocks.css" rel="stylesheet" />
	<link href="stylesheets/workspace.css" rel="stylesheet" />
    <meta name="viewport" content="height=device-height, initial-scale=1.0" />
  </head>
  <body>
    <div class="content">
		<div id="bearPic">
			<img src="images/waterbear_steampunk_trans.png" alt="bear" width=30px height=39px />
		</div>
		<div id="logo">
			<h4>Waterbear</h4>
		</div>
        <div id="accordion" class="block_menu ui-accordion">
			<section class="submenu">
            <h3 class="select"><a href="#">About</a></h3>
            <div class="option">
                <p> <a href="index.html">Info</a></p>
                <p> <a href="docs/index.html">Documentation</a></p>
                <!-- Not sure if this is necessary, better safe than sorry -->
                <p> <a href="license">License</a></p>
                <p> <a href="index.html#help">Help</a></p>
            </div>
			</section>
        </div>
        <div class="tab_bar">
			<span id="radio">
						<input type="radio" id="sblock" name="scriptview" checked="yes" /><label for="sblock">Script Blocks</label>
						<input type="radio" id="stext" name="scriptview"/><label for="stext">Script Text</label>
			</span>
            <button class="run_scripts">Run</button>
            <button class="goto_stage">Show Stage</button>
            <button class="clear_scripts">Clear Scripts</button>
            <button class="demo_scripts">Demos</button>
            <button class="save_scripts">Save</button>
            <button class="restore_scripts">Restore</button>
            <button id="search_enter" type="button" onClick="search($('#search').val())">Enter</button>
			<input id="search" class = 'search-field'/>
        </div>
        <div class="tab_bar2">
            <button class="goto_script">Back to Script</button>
            <button class="clear_canvas">Clear Stage</button>
            <button class="run_scripts">Run</button>
        </div>
        <div class="workspace">
            <div class="scripts_workspace"></div>
            <div class="scripts_text_view"></div>
        </div>
        <div class="stage">
		</div>
    </div>
    <div class="hidden" id="color_popup">
        <div id="color_contents">
		</div>
    </div>	
    <div class="dialog" id="save_dialog" title="Save Script">
		<form id="save_form" class="dialogform">
			<fieldset id="save_fieldset" class="dialogfieldset">
				<h2>Save the current script</h2>
				<input id="script_name" name="script_name" class ="text ui-widget-content ui-corner-all" placeholder="Script Name" />
				<textarea id="script_description" name="script_description" class ="text ui-widget-content ui-corner-all" rows=8 placeholder="Optional Description"></textarea>
			</fieldset>
		</form>
    </div>
	<div class="dialog" id="restore_dialog">
        <div id="restore_dialog_contents">
            <h2>Restore a script</h2>
            <ul class="scrollList" id="script_list">
            </ul>
        </div>
    </div>
    <!--<div class="hidden dialog" id="demos_dialog">
        <div id="demos_dialog_contents">
            <h2>Load a demo</h2>
            <ul class="scrollList" id="demo_list">
            </ul>
            <button class="cancel">Cancel</button>
        </div>
    </div>-->
	<div class="dialog" id="demos_dialog">
        <div id="demos_dialog_contents">
            <h2>Load a demo</h2>
            <ul class="scrollList" id="demo_list">
            </ul>
        </div>
    </div>
	<div class="dialog" id="exp" title="Export Script">
      <h2>Exported Code</h2>
      Copy this into a text document to save for your records.
	  <textarea rows=10 class="text ui-widget-content ui-corner-all"></textarea>
	</div>
	<div class="dialog" id="imp" title="Import Script">
      <h2>Import Code</h2>
      Paste the code generated by the export dialog below.
	  <textarea rows=10 class="text ui-widget-content ui-corner-all"></textarea>
	</div>
	
	<script src="lib/jquery-1.7.2.min.js"></script>
	<!--<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>-->
    <script src="lib/jquery.ui.core.js"></script>
	<script src="lib/jquery.ui.widget.js"></script>
	<script src="lib/jquery.ui.position.js"></script>
	<script src="lib/jquery.ui.autocomplete.js"></script>
	<script src="lib/jquery.hotkeys.js"></script>
    <script src="lib/jquery.querystring.js"></script>
    <script src="lib/yepnope.1.0.2-min.js"></script>
    <script src="lib/jquery.bpopup-0.5.1.min.js"></script>
    <script src="lib/jquery.autoGrowInput.js"></script>
    <script src="lib/json2.js"></script><!-- Make this conditional -->
    <script src="scripts/drag.js"></script>
    <script src="scripts/blocks.js"></script>
    <script src="scripts/runtime.js"></script> <!-- Should this be moved to language? -->
    <script src="scripts/workspace.js"></script>
    <script src="scripts/search.js"></script>
	<script type="text/javascript" src="lib/jquery-ui-1.8.21.custom.min.js"></script>  
<script>
			/*Runs the categories in the search field.*/
			$.widget("custom.catcomplete", $.ui.autocomplete, {
				_renderMenu : function(ul, items) {
					var self = this, currentCategory = "";
					$.each(items, function(index, item) {
						if (item.category != currentCategory) {
							ul.append("<li class='ui-autocomplete-category'>" + item.category + "</li>");
							currentCategory = item.category;
						}
						self._renderItem(ul, item);
					});
				}
			});
		</script>
	<script>
        var q = $.parseQuery();
        // Insert path of plugin to be loaded here
        yepnope({
			load: ["plugins/canvas.js"]
			/*callback: function(){
				alert("canvas loaded");
			}*/
        });
        // This needs to run after the plugin is loaded.
        function pluginReady(){
            load_current_scripts();
            if(q.demo){
                $(document).ready(function(){
                    restore_demo_by_name(q.demo);
                });
            }
			$(function(){
				$("#accordion").accordion({
					collapsible: true, 
					autoHeight: false,
					icons: {
						"header": "ui-icon-circle-triangle-e",
						"headerSelected": "ui-icon-circle-triangle-s"
					}
					header: "> section > h3",
					collapsible: true,
					autoHeight: false

				}).sortable({
					axis: "y",
					handle: "h3 > a",
					stop: function( event, ui ) {
						// IE doesn't register the blur when sorting
						// so trigger focusout handlers to remove .ui-state-focus
						ui.item.children( "h3" ).triggerHandler( "focusout" );
					}
				});
				$( "#radio" ).buttonset();
				$("button").button();
				$("#search").catcomplete({
						source : window.blocknames,
				});

				//Save dialog and associated functions
				function scripts_as_object(){
					var blocks = $('.workspace:visible .scripts_workspace > .wrapper');
					if (blocks.length){
						return blocks.map(function(){return $(this).block_description();}).get();
					}
					else{
						return [];
					}
				}

				function save_current_scripts(){
					show_workspace();
					$('#accordion')[0].scrollIntoView();
					localStorage['__current_scripts'] = JSON.stringify(scripts_as_object());
				}
				
				$(window).unload(save_current_scripts);
				
				$("#save_dialog").dialog({
					autoOpen: false,
					height: 300,
					width: 450,
					modal: true,
					resizable: false,
					buttons: [
					{
						text: "Save",
						"class": 'dialogbutton',
						click: function() {
							var title = $('#script_name').val();
							var description = $('#script_description').val();
							var date = Date.now();
							if (title){
								if (localStorage[title]){
									if (!confirm('A script with that title exist. Overwrite?')){
										return;
									}
								}
								localStorage[title] = JSON.stringify({
									title: title,
									description: description,
									date: date,
									scripts: scripts_as_object()
								});
								$(this).dialog("close");
							}else   
								alert("You must enter a name");
						}
					},
					{
						text: "Export",
						"class": 'dialogbutton',
						click: function() { 
							var title = $('#script_name').val();    
							var description = $('#script_description').val();
							var date = Date.now();
							if (title){
								var exp = JSON.stringify({
									title: title,
									description: description,
									date: date,
									scripts: scripts_as_object()
								});
								$("#save_dialog").dialog("close");
								$('#exp').dialog("open");
								$('#exp textarea').html(exp);
							}
							else
							alert("You must enter a name");
						}
					},
					{
						text: "Cancel",
						"class": 'dialogbutton',
						click: function() {
							$(this).dialog("close");
						}
					}
					],
					close: function(){
						$("#script_name").val("");
						$("#script_description").val("");
					}
				});
				//Restore Dialog and Associated Functions
				function clear_scripts(event, force){
					if (force || confirm('Throw out the current script?')){
						$('.workspace:visible > *').empty();
						$('.stage').replaceWith('<div class="stage"></div>');
					}
				}
				
				function load_scripts_from_object(blocks){
					var workspace = $('.workspace:visible .scripts_workspace');
					$.each(blocks, function(idx, value){
						console.log('restoring block %s', idx);
						var block = Block(value);
						workspace.append(block);
						block.css({position: 'relative', left: 0, top: 0, display: 'block'});
						block.trigger('add_to_workspace');
						$('.scripts_workspace').trigger('add');

					});
				}
				
				function populate_restore_dialog(){
					var list = $('#script_list');
					var script_obj;
					var idx, value, key, script_li;
					for (idx = 0; idx < localStorage.length; idx++){
						key = localStorage.key(idx);
						if (key === '__current_scripts') continue;
						value = localStorage[key];
						script_obj = JSON.parse(value);
						if (script_obj.description){
							script_li = $('<li><span class="title">' + script_obj.title + ' </span><button class="restore action">Restore</button><button class="delete action">Delete</button><button class="show_description action">Description</button><br /><span class="timestamp">Saved on ' + new Date(script_obj.date).toDateString() + '</span><p class="description hidden">' + script_obj.description + '<p></li>');
						}else{
							script_li = $('<li><span class="title">' + script_obj.title + ' </span><button class="restore action">Restore</button><button class="delete action">Delete</button><br /><span class="timestamp">Saved on ' + new Date(script_obj.date).toDateString() + '</span></li>');
						}
						script_li.data('scripts', script_obj.scripts); // avoid re-parsing later
						list.append(script_li);
						$("#restore_dialog button.action").button();
												
						$('#restore_dialog').delegate('.restore', 'click', function(){
							clear_scripts();
							load_scripts_from_object($(this).closest('li').data('scripts'));
							$(this).dialog("close");
						})
											.delegate('.show_description', 'click', function(){
											    $(this).siblings('.description').toggleClass('hidden');
											})
											.delegate('.delete', 'click', function(){
												    if (confirm('Are you sure you want to delete this script?')){
														var title = $(this).siblings('.title').text();
														$(this).parent().remove();
														console.log('remove %s', title);
														localStorage.removeItem(title);
													}
											});                   
					}
				}
				
				$("#restore_dialog").dialog({
					autoOpen: false,
					height: 300,
					width: 450,
					modal: true,
					resizable: false,
					buttons: [
					{
						text: "Import",
						'class': 'dialogbutton',
						click: function(){
							$(this).dialog("close");
							$("#imp").dialog("open");
						}
					},
					{
						text: "Cancel",
						'class': 'dialogbutton',
						click: function(){
							$(this).dialog("close");
						}
					}
					],
					open: function(){
						populate_restore_dialog();
					},
					close: function(){
					    $('#script_list').empty();
					}
				});
				
				//Demos Dialog and associated Functions
				$("#demos_dialog").dialog({
					autoOpen: false,
					height: 300,
					width: 450,
					modal: true,
					resizable: false,
					buttons: [
					{
						text: "Cancel",
						"class": "dialogbutton",
						click: function() {
							$(this).dialog("close");
						}
					}
					]
				});
				
				//Export Dialog
				
				$("#exp").dialog({
					autoOpen: false,
					height: 300,
					width: 350,
					modal: true,
					resizable: false,
					buttons: [
					{
						text: "Cancel",
						"class": 'dialogbutton',
						click: function() {
							$(this).dialog("close");
						}
					}
					]
				});
				$("#imp").dialog({
					autoOpen: false,
					height: 300,
					width: 350,
					modal: true,
					resizable: false,
					buttons: [
					{
						text: "Import",
						"class": 'dialogbutton',
						click: function() {
							var script = $('#imp textarea').val();
							if(script === undefined || script === ''){
								alert('Error Importing script');
								$(this).dialog("close");
								return;
							}
							console.log(script);
							$('#imp').dialog("close");
							clear_scripts();

							var ps = JSON.parse(script);
							console.log(ps.scripts);

							load_scripts_from_object(ps.scripts);
							$(this).dialog("close");
						}
					}
					]
				});
			});
        }
    </script>
  </body>
</html>